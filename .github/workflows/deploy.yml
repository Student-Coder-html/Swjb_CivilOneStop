name: Deploy Component Hub

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Fetch and Build Site
        env:
          GH_TOKEN: ${{ secrets.COMPONENT_HUB_TOKEN }}
        run: |
          mkdir -p _site
          
          # Create a Node.js script to fetch all HTML files
          cat > fetch.js << 'FETCHJS'
          const https = require('https');
          const fs = require('fs');
          
          const TOKEN = process.env.GH_TOKEN;
          const REPO = process.env.GITHUB_REPOSITORY;
          
          async function fetchJSON(path) {
            return new Promise((resolve, reject) => {
              const options = {
                hostname: 'api.github.com',
                path: `/repos/${REPO}/contents/${encodeURIComponent(path)}`,
                headers: {
                  'User-Agent': 'GitHub-Actions',
                  'Authorization': `token ${TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json'
                }
              };
              
              https.get(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch(e) {
                    console.error('Parse error for path:', path);
                    resolve(null);
                  }
                });
              }).on('error', reject);
            });
          }
          
          async function findHTMLFiles(path = '') {
            console.log('Scanning:', path || 'root');
            const contents = await fetchJSON(path);
            
            if (!Array.isArray(contents)) {
              console.log('Not a directory or error:', path);
              return [];
            }
            
            let htmlFiles = [];
            
            for (const item of contents) {
              if (item.type === 'file' && item.name.endsWith('.html')) {
                htmlFiles.push({
                  name: item.name,
                  path: item.path,
                  size: item.size,
                  html_url: item.html_url,
                  download_url: item.download_url
                });
                console.log('Found HTML:', item.path);
              } else if (item.type === 'dir') {
                const subFiles = await findHTMLFiles(item.path);
                htmlFiles = htmlFiles.concat(subFiles);
              }
            }
            
            return htmlFiles;
          }
          
          async function getRepoInfo() {
            return new Promise((resolve, reject) => {
              const options = {
                hostname: 'api.github.com',
                path: `/repos/${REPO}`,
                headers: {
                  'User-Agent': 'GitHub-Actions',
                  'Authorization': `token ${TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json'
                }
              };
              
              https.get(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(JSON.parse(data)));
              }).on('error', reject);
            });
          }
          
          async function main() {
            console.log('Fetching HTML files...');
            const htmlFiles = await findHTMLFiles();
            console.log(`Total HTML files found: ${htmlFiles.length}`);
            
            fs.writeFileSync('_site/components.json', JSON.stringify(htmlFiles, null, 2));
            
            console.log('Fetching repo info...');
            const repoInfo = await getRepoInfo();
            fs.writeFileSync('_site/repo-info.json', JSON.stringify(repoInfo, null, 2));
            
            console.log('‚úÖ Data fetched successfully');
          }
          
          main().catch(console.error);
          FETCHJS
          
          # Run the fetch script
          node fetch.js
          
          # Show what we found
          echo "Components found:"
          cat _site/components.json | head -20
      
      - name: Generate HTML
        run: |
          cat > _site/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="ko">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Component Hub - Swjb_CivilOneStop</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
                      background: #fafafa;
                      color: #1a1a1a;
                      line-height: 1.6;
                  }
                  
                  /* --- START: Loader CSS --- */
                  #loader-overlay {
                      position: fixed;
                      top: 0;
                      left: 0;
                      width: 100%;
                      height: 100%;
                      background: #fafafa;
                      z-index: 9999;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      transition: opacity 0.5s ease;
                  }
                  .loader-content {
                      text-align: center;
                      width: 300px;
                  }
                  .loader-content .logo-icon {
                      width: 48px;
                      height: 48px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      border-radius: 12px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 24px;
                      margin: 0 auto 20px auto;
                  }
                  .loader-content h3 {
                      font-size: 18px;
                      font-weight: 600;
                      color: #1a1a1a;
                      margin-bottom: 20px;
                  }
                  .progress-bar-container {
                      width: 100%;
                      height: 6px;
                      background: #e5e5e5;
                      border-radius: 3px;
                      overflow: hidden;
                      margin-bottom: 16px;
                  }
                  .progress-bar-indeterminate {
                      position: relative;
                      width: 100%;
                      height: 100%;
                  }
                  .progress-bar-indeterminate::before {
                      content: '';
                      position: absolute;
                      height: 100%;
                      width: 60%;
                      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                      border-radius: 3px;
                      animation: indeterminate-progress 1.5s infinite ease-in-out;
                  }
                  .loader-log {
                      font-size: 13px;
                      color: #666;
                      font-family: 'Monaco', monospace;
                  }
                  @keyframes indeterminate-progress {
                      0% { left: -60%; }
                      100% { left: 100%; }
                  }
                  /* --- END: Loader CSS --- */
                  
                  header {
                      background: white;
                      border-bottom: 1px solid #e5e5e5;
                      position: sticky;
                      top: 0;
                      z-index: 100;
                      backdrop-filter: blur(10px);
                      background: rgba(255, 255, 255, 0.95);
                  }
                  .header-container {
                      max-width: 1400px;
                      margin: 0 auto;
                      padding: 24px 40px;
                      display: flex;
                      align-items: center;
                      justify-content: space-between;
                  }
                  .logo {
                      font-size: 20px;
                      font-weight: 600;
                      color: #1a1a1a;
                      display: flex;
                      align-items: center;
                      gap: 12px;
                  }
                  .logo-icon {
                      width: 32px;
                      height: 32px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      border-radius: 8px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      font-size: 18px;
                  }
                  .header-links {
                      display: flex;
                      gap: 32px;
                      align-items: center;
                  }
                  .header-link {
                      color: #666;
                      text-decoration: none;
                      font-size: 14px;
                      font-weight: 500;
                      transition: color 0.2s;
                  }
                  .header-link:hover { color: #1a1a1a; }
                  nav {
                      background: white;
                      border-bottom: 1px solid #e5e5e5;
                  }
                  .nav-container {
                      max-width: 1400px;
                      margin: 0 auto;
                      padding: 0 40px;
                      display: flex;
                      gap: 4px;
                  }
                  .nav-item {
                      padding: 16px 20px;
                      cursor: pointer;
                      font-size: 14px;
                      font-weight: 500;
                      color: #666;
                      border-bottom: 2px solid transparent;
                      transition: all 0.2s;
                  }
                  .nav-item:hover { color: #1a1a1a; }
                  .nav-item.active {
                      color: #667eea;
                      border-bottom-color: #667eea;
                  }
                  main {
                      max-width: 1400px;
                      margin: 0 auto;
                      padding: 60px 40px;
                  }
                  .page-header { margin-bottom: 48px; }
                  .page-title {
                      font-size: 48px;
                      font-weight: 700;
                      color: #1a1a1a;
                      margin-bottom: 12px;
                  }
                  .page-description {
                      font-size: 18px;
                      color: #666;
                      max-width: 600px;
                  }
                  .search-container { margin-bottom: 48px; }
                  .search-box {
                      position: relative;
                      max-width: 600px;
                  }
                  .search-input {
                      width: 100%;
                      padding: 16px 20px 16px 48px;
                      border: 1px solid #e5e5e5;
                      border-radius: 12px;
                      font-size: 15px;
                      transition: all 0.2s;
                      background: white;
                  }
                  .search-input:focus {
                      outline: none;
                      border-color: #667eea;
                      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                  }
                  .search-icon {
                      position: absolute;
                      left: 18px;
                      top: 50%;
                      transform: translateY(-50%);
                      color: #999;
                      font-size: 18px;
                  }
                  .stats-bar {
                      display: flex;
                      gap: 32px;
                      margin-bottom: 32px;
                      padding: 20px 0;
                  }
                  .stat-item {
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      color: #666;
                      font-size: 14px;
                  }
                  .stat-number {
                      font-weight: 600;
                      color: #1a1a1a;
                      font-size: 20px;
                  }
                  .component-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                      gap: 24px;
                  }
                  .component-card {
                      background: white;
                      border: 1px solid #e5e5e5;
                      border-radius: 16px;
                      padding: 28px;
                      transition: all 0.3s;
                      cursor: pointer;
                      position: relative;
                      overflow: hidden;
                  }
                  .component-card::before {
                      content: '';
                      position: absolute;
                      top: 0;
                      left: 0;
                      right: 0;
                      height: 3px;
                      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                      transform: scaleX(0);
                      transition: transform 0.3s;
                  }
                  .component-card:hover {
                      transform: translateY(-4px);
                      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
                      border-color: #667eea;
                  }
                  .component-card:hover::before { transform: scaleX(1); }
                  .component-icon {
                      width: 48px;
                      height: 48px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      border-radius: 12px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      margin-bottom: 20px;
                      font-size: 24px;
                  }
                  .component-name {
                      font-size: 18px;
                      font-weight: 600;
                      color: #1a1a1a;
                      margin-bottom: 8px;
                  }
                  .component-path {
                      font-size: 12px;
                      color: #999;
                      margin-bottom: 16px;
                      font-family: 'Monaco', monospace;
                      overflow: hidden;
                      text-overflow: ellipsis;
                      white-space: nowrap;
                  }
                  .component-meta {
                      display: flex;
                      gap: 8px;
                      flex-wrap: wrap;
                      align-items: center;
                  }
                  .component-tag {
                      background: #f5f5f5;
                      color: #666;
                      padding: 4px 12px;
                      border-radius: 20px;
                      font-size: 12px;
                      font-weight: 500;
                  }
                  .component-size {
                      color: #999;
                      font-size: 12px;
                      margin-left: auto;
                  }
                  .empty-state {
                      grid-column: 1/-1;
                      text-align: center;
                      padding: 80px 20px;
                  }
                  .empty-state-icon {
                      font-size: 64px;
                      margin-bottom: 16px;
                      opacity: 0.3;
                  }
                  .empty-state-title {
                      font-size: 20px;
                      font-weight: 600;
                      color: #1a1a1a;
                      margin-bottom: 8px;
                  }
                  .empty-state-text {
                      color: #999;
                      font-size: 14px;
                  }
                  footer {
                      background: white;
                      border-top: 1px solid #e5e5e5;
                      margin-top: 120px;
                  }
                  .footer-container {
                      max-width: 1400px;
                      margin: 0 auto;
                      padding: 60px 40px 40px;
                  }
                  .repo-info {
                      background: #f5f5f5;
                      padding: 24px;
                      border-radius: 12px;
                      margin-bottom: 48px;
                  }
                  .repo-info strong {
                      color: #1a1a1a;
                      font-weight: 600;
                  }
                  .repo-info a {
                      color: #667eea;
                      text-decoration: none;
                      font-weight: 500;
                  }
                  .repo-info a:hover { text-decoration: underline; }
                  .footer-bottom {
                      border-top: 1px solid #e5e5e5;
                      padding-top: 32px;
                      text-align: center;
                      color: #999;
                      font-size: 13px;
                  }
                  @media (max-width: 768px) {
                      .header-container, .nav-container, main, .footer-container {
                          padding-left: 20px;
                          padding-right: 20px;
                      }
                      .page-title { font-size: 36px; }
                      .component-grid { grid-template-columns: 1fr; }
                      .header-links { display: none; }
                      .loader-content { width: 90%; }
                  }
              </style>
          </head>
          <body>
              <div id="loader-overlay">
                  <div class="loader-content">
                      <div class="logo-icon">üì¶</div>
                      <h3>Loading Component Hub...</h3>
                      <div class="progress-bar-container">
                          <div class="progress-bar-indeterminate"></div>
                      </div>
                      <div class="loader-log" id="loaderLog">Initializing...</div>
                  </div>
              </div>
              <header>
                  <div class="header-container">
                      <div class="logo">
                          <div class="logo-icon">üì¶</div>
                          <span>Component Hub</span>
                      </div>
                      <div class="header-links">
                          <a href="#" class="header-link" id="githubHeaderLink">GitHub</a>
                          <a href="#" class="header-link">Documentation</a>
                      </div>
                  </div>
              </header>
              <nav>
                  <div class="nav-container">
                      <div class="nav-item active" onclick="showCategory('all')">All</div>
                      <div class="nav-item" onclick="showCategory('components')">Components</div>
                      <div class="nav-item" onclick="showCategory('pages')">Pages</div>
                      <div class="nav-item" onclick="showCategory('templates')">Templates</div>
                  </div>
              </nav>
              <main>
                  <div class="page-header">
                      <h1 class="page-title">Component Library</h1>
                      <p class="page-description">
                          Browse and explore government website components from GitHub.
                      </p>
                  </div>
                  <div class="search-container">
                      <div class="search-box">
                          <span class="search-icon">üîç</span>
                          <input type="text" class="search-input" id="searchInput" placeholder="Search components...">
                      </div>
                  </div>
                  <div class="stats-bar" id="statsBar">
                      <div class="stat-item">
                          <span class="stat-number" id="totalCount">0</span>
                          <span>components</span>
                      </div>
                      <div class="stat-item">
                          <span class="stat-number" id="categoryCount">0</span>
                          <span>in category</span>
                      </div>
                  </div>
                  <div class="component-grid" id="componentGrid"></div>
              </main>
              <footer>
                  <div class="footer-container">
                      <div class="repo-info" id="repoInfo"></div>
                      <div class="footer-bottom">
                          <p>Open Source Project ¬∑ Built with ‚ù§Ô∏è</p>
                      </div>
                  </div>
              </footer>
              <script>
                  let allComponents = [];
                  let currentCategory = 'all';

                  // --- START: New Loader Functions ---
                  function updateLoaderLog(message) {
                      const logEl = document.getElementById('loaderLog');
                      if (logEl) {
                          logEl.textContent = message;
                      }
                  }

                  function hideLoader() {
                      const loader = document.getElementById('loader-overlay');
                      if (loader) {
                          loader.style.opacity = '0';
                          // Remove from DOM after fade-out
                          setTimeout(() => {
                              loader.style.display = 'none';
                          }, 500);
                      }
                  }
                  // --- END: New Loader Functions ---

                  function detectCategory(path) {
                      const lowerPath = path.toLowerCase();
                      if (lowerPath.includes('component')) return 'components';
                      if (lowerPath.includes('page')) return 'pages';
                      if (lowerPath.includes('template')) return 'templates';
                      return 'components';
                  }

                  function getIconForFile(name) {
                      const lowerName = name.toLowerCase();
                      if (lowerName.includes('header') || lowerName.includes('nav')) return 'üß≠';
                      if (lowerName.includes('footer')) return 'üîª';
                      if (lowerName.includes('form')) return 'üìù';
                      if (lowerName.includes('table')) return 'üìä';
                      if (lowerName.includes('modal')) return 'üí¨';
                      if (lowerName.includes('search')) return 'üîç';
                      if (lowerName.includes('card')) return 'üé¥';
                      if (lowerName.includes('button')) return 'üîò';
                      if (lowerName.includes('menu')) return '‚ò∞';
                      if (lowerName.includes('login')) return 'üîê';
                      return 'üìÑ';
                  }

                  function formatSize(bytes) {
                      if (bytes < 1024) return bytes + ' B';
                      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                  }

                  async function init() {
                      const startTime = Date.now();
                      const minLoadTime = 1500; // Minimum 1.5 seconds

                      try {
                          updateLoaderLog('Finding content path...');
                          let basePath = window.location.pathname;
                          if (basePath.endsWith('index.html')) {
                              basePath = basePath.substring(0, basePath.lastIndexOf('index.html'));
                          }
                          if (!basePath.endsWith('/')) {
                              basePath += '/';
                          }
                          
                          updateLoaderLog('Fetching component & repo data...');
                          const [componentsData, repoData] = await Promise.all([
                              fetch(basePath + 'components.json').then(r => r.json()),
                              fetch(basePath + 'repo-info.json').then(r => r.json())
                          ]);

                          updateLoaderLog('Processing data...');
                          
                          // --- START: New Label Logic ---
                          allComponents = componentsData.map(item => {
                              const pathParts = item.path.split('/');
                              let rootFolderLabel = null;

                              // Check if path has folders AND the first folder isn't a 'dot-folder'
                              if (pathParts.length > 1 && !pathParts[0].startsWith('.')) {
                                  rootFolderLabel = pathParts[0];
                              }

                              return {
                                  name: item.name.replace('.html', ''),
                                  path: item.path,
                                  size: item.size,
                                  url: item.html_url,
                                  downloadUrl: item.download_url,
                                  category: detectCategory(item.path),
                                  icon: getIconForFile(item.name),
                                  rootLabel: rootFolderLabel // Add the new property
                              };
                          });
                          // --- END: New Label Logic ---

                          const repoUrl = repoData.html_url;
                          document.getElementById('githubHeaderLink').href = repoUrl;

                          document.getElementById('repoInfo').innerHTML = `
                              <strong>Repository:</strong> 
                              <a href="${repoData.html_url}" target="_blank">${repoData.full_name}</a>
                              ${repoData.description ? `<br><small>${repoData.description}</small>` : ''}
                          `;
                          
                          updateLoaderLog(`Found ${allComponents.length} components. Rendering...`);
                          updateStats(allComponents.length, allComponents.length);
                          renderComponents(allComponents);
                          
                          const elapsedTime = Date.now() - startTime;
                          const remainingTime = Math.max(0, minLoadTime - elapsedTime);
                          
                          setTimeout(() => {
                              hideLoader();
                          }, remainingTime);

                      } catch (error) {
                          console.error('Error:', error);
                          const elapsedTime = Date.now() - startTime;
                          const remainingTime = Math.max(0, minLoadTime - elapsedTime);

                          setTimeout(() => {
                              hideLoader(); 
                              document.getElementById('componentGrid').innerHTML = `
                                  <div class="empty-state">
                                      <div class="empty-state-icon">‚ö†Ô∏è</div>
                                      <div class="empty-state-title">Error loading components</div>
                                      <p class="empty-state-text">${error.message}. Check console for details.</p>
                                  </div>
                              `;
                          }, remainingTime);
                      }
                  }

                  function updateStats(total, filtered) {
                      document.getElementById('totalCount').textContent = total;
                      document.getElementById('categoryCount').textContent = filtered;
                  }

                  function renderComponents(componentsToRender) {
                      const grid = document.getElementById('componentGrid');
                      grid.innerHTML = '';

                      if (componentsToRender.length === 0) {
                          grid.innerHTML = `
                              <div class="empty-state">
                                  <div class="empty-state-icon">üîç</div>
                                  <div class="empty-state-title">No results found</div>
                                  <p class="empty-state-text">Try adjusting your search or filter</p>
                              </div>
                          `;
                          return;
                      }

                      componentsToRender.forEach(component => {
                          const card = document.createElement('div');
                          card.className = 'component-card';
                          card.onclick = () => window.open(component.url, '_blank');
                          
                          // --- START: Updated Card HTML ---
                          card.innerHTML = `
                              <div class="component-icon">${component.icon}</div>
                              <div class="component-name">${component.name}</div>
                              <div class="component-path">${component.path}</div>
                              <div class="component-meta">
                                  <span class="component-tag">${component.category}</span>
                                  ${component.rootLabel ? `<span class="component-tag">${component.rootLabel}</span>` : ''}
                                  <span class="component-size">${formatSize(component.size)}</span>
                              </div>
                          `;
                          // --- END: Updated Card HTML ---
                          
                          grid.appendChild(card);
                      });
                  }

                  function showCategory(category) {
                      currentCategory = category;
                      document.querySelectorAll('.nav-item').forEach(item => {
                          item.classList.remove('active');
                      });
                      event.target.classList.add('active');

                      const filtered = category === 'all'
                          ? allComponents
                          : allComponents.filter(c => c.category === category);

                      updateStats(allComponents.length, filtered.length);
                      renderComponents(filtered);
                  }

                  function searchComponents() {
                      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                      
                      // --- START: Updated Search Logic ---
                      // Now also search the rootLabel
                      const filtered = allComponents.filter(c =>
                          c.name.toLowerCase().includes(searchTerm) ||
                          c.path.toLowerCase().includes(searchTerm) ||
                          (c.rootLabel && c.rootLabel.toLowerCase().includes(searchTerm))
                      );
                      // --- END: Updated Search Logic ---
                      
                      updateStats(allComponents.length, filtered.length);
                      renderComponents(filtered);
                  }

                  document.getElementById('searchInput').addEventListener('input', searchComponents);
                  window.addEventListener('DOMContentLoaded', init);
              </script>
          </body>
          </html>
          HTMLEOF
          
          echo "‚úÖ HTML generated"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4